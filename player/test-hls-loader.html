<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>HLS Loader Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        h1 {
            color: #4ec9b0;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #1177bb;
        }

        pre {
            background: #252526;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }
    </style>
</head>

<body>
    <h1>üß™ HLS Loader Test</h1>

    <h2>Step 1: Get Info</h2>
    <button onclick="getInfo()">‚ñ∂ Get Video Info</button>
    <pre id="info">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>

    <h2>Step 2: Get Master Playlist</h2>
    <button onclick="getMaster()">‚ñ∂ Get Master.m3u8</button>
    <pre id="master">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>

    <h2>Step 3: Load in Player</h2>
    <button onclick="loadInPlayer()">‚ñ∂ Load Video</button>
    <div id="player-container"></div>

    <script>
        const LUN = 'lun1';
        const PATH = 'Fantasticheskaya.4.pervie.shagi.2025.WEB-DL.1080p';

        async function getInfo() {
            const result = document.getElementById('info');
            result.innerHTML = '<span class="success">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span>';

            try {
                const url = `/player/hls-loader.php?action=info&lun=${LUN}&path=${encodeURIComponent(PATH)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    result.innerHTML = `<span class="success">‚úÖ SUCCESS!</span>\n\n` +
                        `<strong>–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π:</strong> ${data.profiles.length}\n\n` +
                        data.profiles.map(p => `  - profile_${p.number}_${p.resolution}p`).join('\n') +
                        `\n\n<strong>Master URL:</strong>\n/player/hls-loader.php${data.masterUrl}\n\n` +
                        `<strong>–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong>\n` +
                        JSON.stringify(data, null, 2);
                } else {
                    result.innerHTML = `<span class="error">‚ùå ERROR:</span>\n${data.error}`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå EXCEPTION:</span>\n${error.message}`;
            }
        }

        async function getMaster() {
            const result = document.getElementById('master');
            result.innerHTML = '<span class="success">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span>';

            try {
                const url = `/player/hls-loader.php?action=master&lun=${LUN}&path=${encodeURIComponent(PATH)}`;
                const response = await fetch(url);
                const text = await response.text();

                result.innerHTML = `<span class="success">‚úÖ Master Playlist:</span>\n\n${text}`;
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå EXCEPTION:</span>\n${error.message}`;
            }
        }

        async function loadInPlayer() {
            const container = document.getElementById('player-container');
            const masterUrl = `/player/hls-loader.php?action=master&lun=${LUN}&path=${encodeURIComponent(PATH)}`;

            container.innerHTML = `
                <video id="test-video" controls style="width: 100%; max-width: 800px; margin-top: 20px;">
                </video>
                <pre id="player-log">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
            `;

            const video = document.getElementById('test-video');
            const log = document.getElementById('player-log');

            if (window.Hls && Hls.isSupported()) {
                const hls = new Hls({
                    debug: true
                });

                hls.loadSource(masterUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                    log.innerHTML = `<span class="success">‚úÖ –ú–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!</span>\n\n` +
                        `<strong>–£—Ä–æ–≤–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–∞:</strong>\n` +
                        data.levels.map((l, i) => `  ${i}: ${l.height}p - ${(l.bitrate / 1000).toFixed(0)} kbps`).join('\n') +
                        `\n\n<strong>–ê—É–¥–∏–æ-–¥–æ—Ä–æ–∂–∫–∏:</strong>\n` +
                        (data.audioTracks?.length ?
                            data.audioTracks.map((t, i) => `  ${i}: ${t.name} (${t.lang})`).join('\n') :
                            '  –ù–µ—Ç');

                    video.play();
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    log.innerHTML += `\n\n<span class="error">‚ùå –û—à–∏–±–∫–∞:</span>\n${JSON.stringify(data, null, 2)}`;
                });

            } else {
                log.innerHTML = '<span class="error">‚ùå HLS.js –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>';
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</body>

</html>